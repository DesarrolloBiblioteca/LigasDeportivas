name: Discord Notifications
on:
  push:
    branches: [ main, develop, feature/**, bugfix/**, hotfix/** ]
  pull_request:
    types: [opened, closed, reopened, ready_for_review]
  issues:
    types: [opened, closed, reopened]
jobs:
  notify-commit:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Notificar commits a Discord
        run: |
          curl -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "üöÄ Nuevo Commit en '"${{ github.repository }}"'",
              "description": "**Rama:** `'"${{ github.ref_name }}"'`\n**Autor:** '"${{ github.actor }}"'\n**Mensaje:** '"${{ github.event.head_commit.message }}"'",
              "color": 3447003,
              "url": "'"${{ github.event.head_commit.url }}"'",
              "footer": {
                "text": "GitHub Actions"
              },
              "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK_COMMITS }}
  
  notify-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Extract Jira Issue Key
        id: jira_key
        run: |
          ISSUE_KEY=$(echo "${{ github.event.pull_request.title }}" | grep -oE 'DES-[0-9]+' || echo "")
          echo "issue_key=$ISSUE_KEY" >> $GITHUB_OUTPUT
          if [ -n "$ISSUE_KEY" ]; then
            echo "‚úÖ Found Jira issue: $ISSUE_KEY"
          else
            echo "‚ö†Ô∏è No Jira issue key found in PR title"
          fi

      - name: Move Jira issue to IN REVIEW
        if: github.event.action == 'opened' && steps.jira_key.outputs.issue_key != ''
        run: |
          echo "Moving ${{ steps.jira_key.outputs.issue_key }} to IN REVIEW..."
          curl -X POST \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"transition":{"id":"3"}}' \
            "https://alumnos-team-myphxh4c.atlassian.net/rest/api/3/issue/${{ steps.jira_key.outputs.issue_key }}/transitions"

      - name: Move Jira issue to DONE
        if: github.event.pull_request.merged == true && steps.jira_key.outputs.issue_key != ''
        run: |
          echo "Moving ${{ steps.jira_key.outputs.issue_key }} to DONE..."
          curl -X POST \
            -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"transition":{"id":"6"}}' \
            "https://alumnos-team-myphxh4c.atlassian.net/rest/api/3/issue/${{ steps.jira_key.outputs.issue_key }}/transitions"

      - name: Notificar PR a Discord
        run: |
          COLOR=15844367
          if [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            COLOR=5763719
            ACTION_TEXT="‚úÖ merged"
          elif [ "${{ github.event.action }}" = "closed" ]; then
            COLOR=15158332
            ACTION_TEXT="‚ùå closed"
          elif [ "${{ github.event.action }}" = "opened" ]; then
            COLOR=15844367
            ACTION_TEXT="üì¨ opened"
          else
            ACTION_TEXT="${{ github.event.action }}"
          fi
          
          curl -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "Pull Request '"$ACTION_TEXT"'",
              "description": "**'"${{ github.event.pull_request.title }}"'**\n\n**Autor:** '"${{ github.event.pull_request.user.login }}"'\n**Rama:** `'"${{ github.event.pull_request.head.ref }}"'` ‚Üí `'"${{ github.event.pull_request.base.ref }}"'`",
              "color": '"$COLOR"',
              "url": "'"${{ github.event.pull_request.html_url }}"'",
              "footer": {
                "text": "GitHub Actions"
              },
              "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK_PRS }}
  
  notify-issue:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Notificar Issue a Discord
        run: |
          COLOR=16776960
          if [ "${{ github.event.action }}" = "opened" ]; then
            ACTION_TEXT="üêõ abierto"
            COLOR=16776960
          elif [ "${{ github.event.action }}" = "closed" ]; then
            ACTION_TEXT="‚úÖ cerrado"
            COLOR=5763719
          else
            ACTION_TEXT="${{ github.event.action }}"
          fi
          
          curl -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "Issue '"$ACTION_TEXT"'",
              "description": "**'"${{ github.event.issue.title }}"'**\n\n**Autor:** '"${{ github.event.issue.user.login }}"'",
              "color": '"$COLOR"',
              "url": "'"${{ github.event.issue.html_url }}"'",
              "footer": {
                "text": "GitHub Actions"
              },
              "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
            }]
          }' \
          ${{ secrets.DISCORD_WEBHOOK_ISSUES }}
